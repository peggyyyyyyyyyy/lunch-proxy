<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lunch Go! ä¼æ¥­ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .active-nav { color: #3b82f6; border-top: 3px solid #3b82f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        @keyframes shake {
            0% { transform: translate(1px, 1px); }
            20% { transform: translate(-3px, 0px); }
            40% { transform: translate(1px, -1px); }
            100% { transform: translate(1px, 1px); }
        }
        .shaking { animation: shake 0.2s infinite; }
        #gacha-box { transition: all 0.3s ease; }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col overflow-hidden text-gray-800">

    <header class="bg-white p-4 shadow-sm flex justify-between items-center flex-shrink-0">
        <h1 class="text-xl font-black text-blue-600 italic tracking-tighter">LUNCH GO!</h1>
        <span id="user-id" class="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded-full font-mono font-bold">#User---</span>
    </header>

    <main class="flex-1 overflow-y-auto no-scrollbar pb-20">
        
        <section id="tab-recommend" class="tab-content active p-4">
            <div id="location-status" class="text-[10px] text-gray-400 mb-3 text-center">æ­£åœ¨æŠ“å–æ‚¨çš„ä½ç½®...</div>
            
            <div class="bg-white rounded-2xl p-4 shadow-sm mb-4 border border-gray-100">
                <div class="flex justify-between items-center">
                    <button onclick="filterByMood('happy')" class="flex flex-col items-center gap-1"><span class="text-3xl">ğŸ˜Š</span><span class="text-[10px] text-gray-400">é–‹å¿ƒ</span></button>
                    <button onclick="filterByMood('sad')" class="flex flex-col items-center gap-1"><span class="text-3xl">ğŸ˜¢</span><span class="text-[10px] text-gray-400">é›£é</span></button>
                    <button onclick="filterByMood('angry')" class="flex flex-col items-center gap-1"><span class="text-3xl">ğŸ’¢</span><span class="text-[10px] text-gray-400">ç”Ÿæ°£</span></button>
                    <button onclick="filterByMood('fit')" class="flex flex-col items-center gap-1"><span class="text-3xl">ğŸ’ª</span><span class="text-[10px] text-gray-400">å¥èº«</span></button>
                    <button onclick="filterByMood('nervous')" class="flex flex-col items-center gap-1"><span class="text-3xl">ğŸ·</span><span class="text-[10px] text-gray-400">ç·Šå¼µ</span></button>
                </div>
            </div>

            <div class="flex gap-2 mb-4">
                <button id="btn-online" onclick="toggleOnline()" class="flex-1 bg-white border border-gray-200 py-2.5 rounded-xl text-xs font-bold shadow-sm transition">ğŸ›µ ç·šä¸Šè¨‚é¤å„ªå…ˆ</button>
                <button onclick="openFilter()" class="flex-1 bg-blue-600 text-white py-2.5 rounded-xl text-xs font-bold shadow-sm"><i class="fa-solid fa-sliders mr-1"></i> é€²éšç¯©é¸</button>
            </div>

            <div id="restaurant-list" class="space-y-3"></div>
        </section>

        <section id="tab-gacha" class="tab-content p-6 text-center">
            <h2 class="text-2xl font-black mt-10">åƒä»€éº¼å¥½å‘¢ï¼Ÿ</h2>
            <p class="text-xs text-gray-400 mb-10 tracking-widest uppercase">è®“ç³»çµ±ç‚ºæ‚¨è§£æ±ºé›£é¡Œ</p>
            
            <div id="gacha-box" class="w-full h-48 bg-white border-4 border-blue-500 rounded-3xl shadow-xl flex flex-col items-center justify-center p-6 mb-10">
                <div id="gacha-result-name" class="text-2xl font-black text-blue-600 mb-2">? ? ?</div>
                <div id="gacha-result-sub" class="text-sm text-gray-400 font-bold">é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹</div>
            </div>
            
            <div class="space-y-4">
                <p class="text-xs text-gray-400 font-bold">ä»Šæ—¥é¤˜é¡: <span id="draw-count" class="text-blue-600">3</span> / 3</p>
                <button id="btn-draw" onclick="handleDraw()" class="w-full bg-gray-900 text-white py-4 rounded-2xl font-black shadow-lg active:scale-95 transition">
                    éš¨æ©Ÿæ¨è–¦é¤å»³
                </button>
                <div id="snarky-text" class="text-red-500 text-xs font-bold opacity-0 transition-opacity h-4">å°±ä½ å•æœ€å¤š ğŸ™„</div>
            </div>
        </section>

        <section id="tab-group" class="tab-content p-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black">éƒ¨é–€æªåœ˜å€</h2>
                <button class="bg-orange-500 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-lg">+ æˆ‘è¦ç™¼èµ·</button>
            </div>
            <div class="bg-white p-5 rounded-2xl shadow-sm border-l-8 border-orange-500 mb-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="bg-orange-100 text-orange-600 text-[10px] px-2 py-1 rounded font-bold italic">å³å°‡æˆªæ­¢ 11:30</span>
                </div>
                <h3 class="font-bold text-lg">å¤§å®¶ä¸€èµ·è¨‚ [å¥åº·é¤ç›’]</h3>
                <p class="text-xs text-gray-400 mt-1">æ­¤åŠŸèƒ½ä¸²æ¥ä¸­ï¼Œæ•¬è«‹æœŸå¾…...</p>
            </div>
        </section>
    </main>

    <div id="filter-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end">
        <div class="bg-white w-full rounded-t-3xl p-6 pb-10">
            <h3 class="font-black text-lg mb-4">ç¯©é¸è¨­å®š</h3>
            <div class="mb-4">
                <p class="text-xs font-bold text-gray-400 mb-2 uppercase">é¤é»ç¨®é¡</p>
                <div class="flex flex-wrap gap-2" id="type-tags">
                    <button onclick="setType('Chinese')" class="px-4 py-2 rounded-xl border text-xs font-bold">ä¸­å¼</button>
                    <button onclick="setType('Japanese')" class="px-4 py-2 rounded-xl border text-xs font-bold">æ—¥å¼</button>
                    <button onclick="setType('Pizza')" class="px-4 py-2 rounded-xl border text-xs font-bold">æŠ«è–©/è¥¿å¼</button>
                    <button onclick="setType('Cafe')" class="px-4 py-2 rounded-xl border text-xs font-bold">å’–å•¡/è¼•é£Ÿ</button>
                </div>
            </div>
            <div class="mb-6">
                <p class="text-xs font-bold text-gray-400 mb-2 uppercase">åƒ¹æ ¼å€é–“</p>
                <div class="flex gap-2">
                    <button onclick="setPrice(1)" class="flex-1 py-2 rounded-xl border text-xs font-bold">$ (å¹³åƒ¹)</button>
                    <button onclick="setPrice(2)" class="flex-1 py-2 rounded-xl border text-xs font-bold">$$ (ä¸­åƒ¹)</button>
                    <button onclick="setPrice(3)" class="flex-1 py-2 rounded-xl border text-xs font-bold">$$$ (è±ªè¯)</button>
                </div>
            </div>
            <button onclick="closeFilter()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black">å¥—ç”¨ä¸¦æœå°‹</button>
        </div>
    </div>

    <nav class="bg-white border-t flex justify-around items-center h-20 pb-4 flex-shrink-0 z-50">
        <button onclick="switchTab('recommend')" id="nav-recommend" class="flex flex-col items-center gap-1 active-nav flex-1"><i class="fa-solid fa-utensils text-xl"></i><span class="text-[10px] font-bold">é™„è¿‘æ¨è–¦</span></button>
        <button onclick="switchTab('gacha')" id="nav-gacha" class="flex flex-col items-center gap-1 flex-1"><i class="fa-solid fa-dice text-xl"></i><span class="text-[10px] font-bold">éš¨æ©ŸæŠ½ç±¤</span></button>
        <button onclick="switchTab('group')" id="nav-group" class="flex flex-col items-center gap-1 flex-1"><i class="fa-solid fa-users text-xl"></i><span class="text-[10px] font-bold">åŒäº‹æªåœ˜</span></button>
    </nav>

    <script>
        const ZEABUR_URL = "https://lunch-go.zeabur.app"; // è«‹æ›¿æ›
        let allPlaces = [], drawLimit = 3, isOnlineOnly = false;
        let currentLat, currentLng, selectedType = "", selectedPrice = "";

        window.onload = () => {
            document.getElementById('user-id').innerText = `#User${Math.floor(Math.random()*899)+100}`;
            initLocation();
        };

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('active-nav'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.getElementById(`nav-${tabId}`).classList.add('active-nav');
        }

        function initLocation() {
            navigator.geolocation.getCurrentPosition(pos => {
                currentLat = pos.coords.latitude;
                currentLng = pos.coords.longitude;
                document.getElementById('location-status').innerText = "ğŸ“ æ­¥è¡Œ 20 åˆ†é˜è·¯ç¨‹æœå°‹ä¸­";
                fetchData();
            });
        }

        async function fetchData(keyword = "") {
            const listEl = document.getElementById('restaurant-list');
            listEl.innerHTML = `<div class="text-center py-10 animate-pulse text-gray-400">ğŸ” æœå°‹ç¾å‘³ä¸­...</div>`;
            
            let url = `${ZEABUR_URL}/api/restaurants?lat=${currentLat}&lng=${currentLng}&radius=1600&keyword=${keyword || selectedType}`;
            if (selectedPrice) url += `&price_level=${selectedPrice}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.status === "OK") {
                    allPlaces = data.results;
                    applyFilterAndRender();
                }
            } catch (err) { listEl.innerHTML = `<p class="text-center text-red-400 text-xs">é€£ç·šå¤±æ•—</p>`; }
        }

        function applyFilterAndRender() {
            let filtered = isOnlineOnly ? allPlaces.filter(p => p.opening_hours?.open_now) : allPlaces;
            const listEl = document.getElementById('restaurant-list');
            if (filtered.length === 0) { listEl.innerHTML = `<div class="text-center py-10 text-gray-400 text-xs">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é¤å»³ ğŸ˜¢</div>`; return; }

            listEl.innerHTML = filtered.map(place => `
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center active:bg-gray-50" onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}&query_place_id=${place.place_id}')">
                    <div class="flex-1">
                        <h4 class="font-bold text-gray-800">${place.name}</h4>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs text-yellow-500 font-bold font-mono">â­ ${place.rating || '4.0'}</span>
                            <span class="text-[10px] text-gray-400">| ${place.vicinity.substring(0,18)}</span>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                </div>
            `).join('');
        }

        function toggleOnline() {
            isOnlineOnly = !isOnlineOnly;
            const btn = document.getElementById('btn-online');
            btn.className = isOnlineOnly ? "flex-1 bg-green-500 text-white py-2.5 rounded-xl text-xs font-bold shadow-md transition" : "flex-1 bg-white border border-gray-200 py-2.5 rounded-xl text-xs font-bold shadow-sm transition";
            applyFilterAndRender();
        }

        function filterByMood(mood) {
            const moodMap = { 'happy': 'é€Ÿé£Ÿ', 'sad': 'ç”œé»', 'angry': 'é£²æ–™', 'fit': 'å¥åº·é¤', 'nervous': 'é…’' };
            fetchData(moodMap[mood]);
        }

        function openFilter() { document.getElementById('filter-modal').classList.remove('hidden'); }
        function closeFilter() { document.getElementById('filter-modal').classList.add('hidden'); fetchData(); }
        function setType(t) { selectedType = t; alert(`å·²é¸æ“‡: ${t}`); }
        function setPrice(p) { selectedPrice = p; alert(`å·²è¨­å®šåƒ¹æ ¼ç­‰ç´š: ${p}`); }

        function handleDraw() {
            if (drawLimit <= 0 || allPlaces.length === 0) return;
            const box = document.getElementById('gacha-box');
            const nameEl = document.getElementById('gacha-result-name');
            const subEl = document.getElementById('gacha-result-sub');
            const snarky = document.getElementById('snarky-text');

            box.classList.add('shaking');
            nameEl.innerText = "ğŸ² æŠ½çä¸­...";
            subEl.innerText = "å¥½æœŸå¾…å•Š~";

            setTimeout(() => {
                box.classList.remove('shaking');
                drawLimit--;
                document.getElementById('draw-count').innerText = drawLimit;
                const lucky = allPlaces[Math.floor(Math.random() * allPlaces.length)];
                
                nameEl.innerText = lucky.name;
                subEl.innerText = `â­ è©•åˆ†: ${lucky.rating || 'N/A'} (é»æ“Šä¸‹æ–¹å†æŠ½ä¸€æ¬¡)`;
                
                snarky.style.opacity = "1";
                if(drawLimit === 2) snarky.innerText = "ä¸æ»¿æ„å–”ï¼ŸğŸ¤¨";
                if(drawLimit === 1) snarky.innerText = "æœ€å¾Œä¸€æ¬¡å›‰...ğŸ˜®â€ğŸ’¨";
                if(drawLimit === 0) { snarky.innerText = "å°±ä½ å•æœ€å¤šï¼æ˜å¤©è¦‹ ğŸ‘‹"; document.getElementById('btn-draw').disabled = true; document.getElementById('btn-draw').classList.add('bg-gray-300'); }
            }, 1000);
        }
    </script>
</body>
</html>