<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lunch Go! ä¼æ¥­ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .active-nav { color: #3b82f6; border-top: 3px solid #3b82f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        @keyframes shake {
            0% { transform: translate(1px, 1px); }
            20% { transform: translate(-3px, 0px); }
            40% { transform: translate(1px, -1px); }
            100% { transform: translate(1px, 1px); }
        }
        .shaking { animation: shake 0.2s infinite; }
        /* é¸å–ç‹€æ…‹é¡è‰² */
        .tag-selected { background-color: #3b82f6 !important; color: white !important; border-color: #3b82f6 !important; }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col overflow-hidden text-gray-800">

    <header class="bg-white p-4 shadow-sm flex justify-between items-center flex-shrink-0">
        <h1 class="text-xl font-black text-blue-600 italic tracking-tighter">LUNCH GO!</h1>
        <span id="user-id" class="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded-full font-mono font-bold">#User---</span>
    </header>

    <main class="flex-1 overflow-y-auto no-scrollbar pb-20">
        
        <section id="tab-recommend" class="tab-content active p-4">
            <div id="location-status" class="text-[10px] text-gray-400 mb-4 text-center">ğŸ“ æœå°‹ç¯„åœï¼šæ­¥è¡Œ 20 åˆ†é˜å…§</div>
            
            <div class="flex gap-2 mb-6">
                <button id="btn-online" onclick="toggleOnline()" class="flex-1 bg-white border border-gray-200 py-3 rounded-2xl text-xs font-bold shadow-sm transition-all">ğŸ›µ ç·šä¸Šè¨‚é¤å„ªå…ˆ</button>
                <button onclick="openFilter()" class="flex-1 bg-blue-600 text-white py-3 rounded-2xl text-xs font-bold shadow-lg"><i class="fa-solid fa-sliders mr-2"></i>é€²éšç¯©é¸</button>
            </div>

            <div id="restaurant-list" class="space-y-3">
                <div class="text-center py-20 text-gray-300 text-sm">æ­£åœ¨è¼‰å…¥é™„è¿‘ç¾å‘³...</div>
            </div>
        </section>

        <section id="tab-gacha" class="tab-content p-6 text-center">
            <h2 class="text-2xl font-black mt-10">åƒä»€éº¼å¥½å‘¢ï¼Ÿ</h2>
            <p class="text-xs text-gray-400 mb-10 tracking-widest">è®“ç³»çµ±ç‚ºæ‚¨è§£æ±ºé›£é¡Œ</p>
            
            <div id="gacha-box" onclick="goToLuckyRes()" class="w-full h-52 bg-white border-4 border-blue-500 rounded-3xl shadow-xl flex flex-col items-center justify-center p-6 mb-10 cursor-pointer active:scale-95 transition-transform">
                <div id="gacha-result-name" class="text-2xl font-black text-blue-600 mb-2">? ? ?</div>
                <div id="gacha-result-sub" class="text-xs text-gray-400 font-bold italic">é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹</div>
                <div id="gacha-click-hint" class="hidden mt-4 text-[10px] bg-blue-50 text-blue-500 px-3 py-1 rounded-full animate-pulse">é»æ“Šæ¡†æ¡†æŸ¥çœ‹è©³æƒ… â”</div>
            </div>
            
            <div class="space-y-4">
                <p class="text-xs text-gray-400 font-bold">ä»Šæ—¥é¤˜é¡: <span id="draw-count" class="text-blue-600">3</span> / 3</p>
                <button id="btn-draw" onclick="handleDraw()" class="w-full bg-gray-900 text-white py-4 rounded-2xl font-black shadow-lg active:scale-95 transition">éš¨æ©Ÿæ¨è–¦é¤å»³</button>
                <div id="snarky-text" class="text-red-500 text-[10px] font-bold opacity-0 transition-opacity h-4">å°±ä½ å•æœ€å¤š ğŸ™„</div>
            </div>
        </section>

        <section id="tab-group" class="tab-content p-4">
            <h2 class="text-xl font-black mb-6">éƒ¨é–€æªåœ˜å€</h2>
            <div class="bg-white p-8 rounded-3xl text-center border-2 border-dashed border-gray-200">
                <i class="fa-solid fa-comments-dollar text-4xl text-gray-200 mb-4"></i>
                <p class="text-sm text-gray-400">æªåœ˜èˆ‡è©•è«–åŠŸèƒ½é–‹ç™¼ä¸­<br>å³å°‡ä¸²æ¥è³‡æ–™åº«...</p>
            </div>
        </section>
    </main>

    <div id="filter-modal" class="fixed inset-0 bg-black/70 z-[60] hidden flex items-end">
        <div class="bg-white w-full rounded-t-[40px] p-8 pb-12 animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-xl">é€²éšç¯©é¸</h3>
                <button onclick="resetFilters()" class="text-xs text-blue-500 font-bold underline">é‡è¨­</button>
            </div>
            
            <div class="mb-6">
                <p class="text-[10px] font-black text-gray-400 mb-3 uppercase tracking-widest">é¤é»ç¨®é¡ (å¯è¤‡é¸)</p>
                <div class="flex flex-wrap gap-2" id="type-tags">
                    <button onclick="toggleTypeTag(this, 'ä¸­å¼')" class="type-tag px-4 py-2 rounded-xl border border-gray-100 bg-gray-50 text-xs font-bold transition-all">ä¸­å¼</button>
                    <button onclick="toggleTypeTag(this, 'æ—¥å¼')" class="type-tag px-4 py-2 rounded-xl border border-gray-100 bg-gray-50 text-xs font-bold transition-all">æ—¥å¼</button>
                    <button onclick="toggleTypeTag(this, 'è¥¿å¼')" class="type-tag px-4 py-2 rounded-xl border border-gray-100 bg-gray-50 text-xs font-bold transition-all">è¥¿å¼</button>
                    <button onclick="toggleTypeTag(this, 'ç”œé»')" class="type-tag px-4 py-2 rounded-xl border border-gray-100 bg-gray-50 text-xs font-bold transition-all">ç”œé»</button>
                    <button onclick="toggleTypeTag(this, 'å¥åº·é¤')" class="type-tag px-4 py-2 rounded-xl border border-gray-100 bg-gray-50 text-xs font-bold transition-all">å¥åº·é¤</button>
                </div>
            </div>

            <div class="mb-8">
                <p class="text-[10px] font-black text-gray-400 mb-3 uppercase tracking-widest">åƒ¹æ ¼å€é–“ (å¯è¤‡é¸)</p>
                <div class="flex gap-2">
                    <button onclick="togglePriceTag(this, '1')" class="price-tag flex-1 py-3 rounded-xl border border-gray-100 bg-gray-50 text-xs font-bold transition-all">$</button>
                    <button onclick="togglePriceTag(this, '2')" class="price-tag flex-1 py-3 rounded-xl border border-gray-100 bg-gray-50 text-xs font-bold transition-all">$$</button>
                    <button onclick="togglePriceTag(this, '3')" class="price-tag flex-1 py-3 rounded-xl border border-gray-100 bg-gray-50 text-xs font-bold transition-all">$$$</button>
                </div>
            </div>

            <button onclick="applyFilters()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black shadow-lg">å¥—ç”¨æ¢ä»¶ä¸¦æœå°‹</button>
        </div>
    </div>

    <nav class="bg-white border-t flex justify-around items-center h-20 pb-4 flex-shrink-0 z-50">
        <button onclick="switchTab('recommend')" id="nav-recommend" class="flex flex-col items-center gap-1 active-nav flex-1"><i class="fa-solid fa-utensils text-xl"></i><span class="text-[10px] font-bold">é™„è¿‘æ¨è–¦</span></button>
        <button onclick="switchTab('gacha')" id="nav-gacha" class="flex flex-col items-center gap-1 flex-1"><i class="fa-solid fa-dice text-xl"></i><span class="text-[10px] font-bold">éš¨æ©ŸæŠ½ç±¤</span></button>
        <button onclick="switchTab('group')" id="nav-group" class="flex flex-col items-center gap-1 flex-1"><i class="fa-solid fa-users text-xl"></i><span class="text-[10px] font-bold">åŒäº‹æªåœ˜</span></button>
    </nav>

    <script>
        const ZEABUR_URL = "https://lunch-go.zeabur.app"; 
        let allPlaces = [], drawLimit = 3, isOnlineOnly = false;
        let currentLat, currentLng, luckyPlace = null;
        let selectedTypes = [], selectedPrices = [];

        window.onload = () => {
            document.getElementById('user-id').innerText = `#User${Math.floor(Math.random()*899)+100}`;
            initLocation();
        };

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('active-nav'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.getElementById(`nav-${tabId}`).classList.add('active-nav');
        }

        function initLocation() {
            navigator.geolocation.getCurrentPosition(pos => {
                currentLat = pos.coords.latitude;
                currentLng = pos.coords.longitude;
                fetchData();
            }, () => {
                document.getElementById('location-status').innerText = "âŒ å®šä½å¤±æ•—ï¼Œè«‹é–‹å•Ÿ GPS";
            });
        }

        // çœŸå¯¦ç¯©é¸é€£å‹•
        async function fetchData() {
            const listEl = document.getElementById('restaurant-list');
            listEl.innerHTML = `<div class="text-center py-20 animate-pulse text-gray-300 text-xs italic">æ­£åœ¨æŒ‘é¸é™„è¿‘çš„ç¾å‘³...</div>`;
            
            // çµ„åˆè¤‡é¸é—œéµå­— (ä¸­å¼+æ—¥å¼)
            const keywordStr = selectedTypes.join(' ');
            const priceStr = selectedPrices.join(','); // é›–ç„¶ Places API é™åˆ¶è¼ƒå¤šï¼Œä½†æˆ‘å€‘å…ˆå‚³çµ¦å¾Œç«¯è™•ç†

            let url = `${ZEABUR_URL}/api/restaurants?lat=${currentLat}&lng=${currentLng}&radius=1600&keyword=${encodeURIComponent(keywordStr)}`;
            if (selectedPrices.length > 0) url += `&price_level=${selectedPrices[0]}`; // Google API é€šå¸¸ä¸€æ¬¡æ”¶ä¸€å€‹åƒ¹æ ¼ç­‰ç´š

            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.status === "OK") {
                    allPlaces = data.results;
                    renderList();
                }
            } catch (err) { listEl.innerHTML = `<p class="text-center text-red-400 text-xs">é€£ç·šå¤±æ•—</p>`; }
        }

        function renderList() {
            let filtered = isOnlineOnly ? allPlaces.filter(p => p.opening_hours?.open_now) : allPlaces;
            const listEl = document.getElementById('restaurant-list');
            
            if (filtered.length === 0) {
                listEl.innerHTML = `<div class="text-center py-20 text-gray-400 text-xs">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é¤å»³ï¼Œè«‹è©¦è‘—æ”¾å¯¬ç¯©é¸ ğŸ˜¢</div>`;
                return;
            }

            listEl.innerHTML = filtered.map(place => `
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center active:bg-gray-50 transition-colors" onclick="openMaps('${place.name}', '${place.place_id}')">
                    <div class="flex-1">
                        <h4 class="font-black text-gray-800 tracking-tight">${place.name}</h4>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="text-xs text-yellow-500 font-black">â­ ${place.rating || '4.0'}</span>
                            <span class="text-[10px] text-gray-400 font-bold">| ${place.vicinity.substring(0,20)}</span>
                        </div>
                    </div>
                    <div class="ml-4 w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-300 text-xs">
                        <i class="fa-solid fa-chevron-right"></i>
                    </div>
                </div>
            `).join('');
        }

        function openMaps(name, id) {
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}&query_place_id=${id}`);
        }

        // ç¯©é¸äº’å‹•
        function toggleTypeTag(btn, type) {
            btn.classList.toggle('tag-selected');
            if (selectedTypes.includes(type)) {
                selectedTypes = selectedTypes.filter(t => t !== type);
            } else {
                selectedTypes.push(type);
            }
        }

        function togglePriceTag(btn, price) {
            // åƒ¹æ ¼é€šå¸¸è¼ƒé©åˆå–®é¸ï¼Œä½†é€™è£¡é…åˆéœ€æ±‚åšè¤‡é¸è¦–è¦ºï¼Œé‚è¼¯å–æœ€é«˜
            btn.classList.toggle('tag-selected');
            if (selectedPrices.includes(price)) {
                selectedPrices = selectedPrices.filter(p => p !== price);
            } else {
                selectedPrices.push(price);
            }
        }

        function openFilter() { document.getElementById('filter-modal').classList.remove('hidden'); }
        function closeFilter() { document.getElementById('filter-modal').classList.add('hidden'); }
        
        function resetFilters() {
            selectedTypes = [];
            selectedPrices = [];
            document.querySelectorAll('.tag-selected').forEach(el => el.classList.remove('tag-selected'));
        }

        function applyFilters() {
            closeFilter();
            fetchData();
        }

        function toggleOnline() {
            isOnlineOnly = !isOnlineOnly;
            const btn = document.getElementById('btn-online');
            btn.classList.toggle('tag-selected');
            renderList();
        }

        // æŠ½ç±¤é‚è¼¯
        function handleDraw() {
            if (drawLimit <= 0 || allPlaces.length === 0) return;
            const box = document.getElementById('gacha-box');
            const nameEl = document.getElementById('gacha-result-name');
            const subEl = document.getElementById('gacha-result-sub');
            const hintEl = document.getElementById('gacha-click-hint');
            const snarky = document.getElementById('snarky-text');

            box.classList.add('shaking');
            nameEl.innerText = "ğŸ² æŒ‘é¸ä¸­...";
            subEl.innerText = "";
            hintEl.classList.add('hidden');

            setTimeout(() => {
                box.classList.remove('shaking');
                drawLimit--;
                document.getElementById('draw-count').innerText = drawLimit;
                luckyPlace = allPlaces[Math.floor(Math.random() * allPlaces.length)];
                
                nameEl.innerText = luckyPlace.name;
                subEl.innerText = `â­ è©•åˆ†: ${luckyPlace.rating || 'N/A'}`;
                hintEl.classList.remove('hidden');
                
                snarky.style.opacity = "1";
                if(drawLimit === 0) {
                    snarky.innerText = "å°±ä½ å•æœ€å¤šï¼æ˜å¤©è¦‹ ğŸ‘‹";
                    document.getElementById('btn-draw').disabled = true;
                    document.getElementById('btn-draw').classList.add('bg-gray-300');
                }
            }, 800);
        }

        function goToLuckyRes() {
            if (luckyPlace) openMaps(luckyPlace.name, luckyPlace.place_id);
        }
    </script>
</body>
</html>