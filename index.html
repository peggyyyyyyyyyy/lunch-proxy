<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lunch Go! ä¼æ¥­ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .active-nav { color: #3b82f6; border-top: 3px solid #3b82f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        @keyframes shake { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(-4px,0); } 75% { transform: translate(4px,0); } }
        .shaking { animation: shake 0.1s infinite; }
        .tag-selected { background-color: #3b82f6 !important; color: white !important; border-color: #3b82f6 !important; }
        .res-card { transition: all 0.2s ease; }
        .res-card:active { transform: scale(0.97); }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col overflow-hidden text-gray-800 font-sans">

    <header class="bg-white p-4 shadow-sm flex justify-between items-center flex-shrink-0 z-50">
        <h1 class="text-xl font-black text-blue-600 italic tracking-tighter">LUNCH GO!</h1>
        <span id="user-id" class="text-[10px] bg-gray-100 text-gray-400 px-3 py-1 rounded-full font-mono font-bold">#User---</span>
    </header>

    <main class="flex-1 overflow-y-auto no-scrollbar pb-24">
        
        <section id="tab-recommend" class="tab-content active p-4">
            <div id="location-status" class="text-[10px] text-gray-400 mb-4 text-center font-bold">æ­£åœ¨æƒææ–¹åœ“ 3 å…¬é‡Œçš„ç¾é£Ÿ...</div>
            
            <div class="flex gap-2 mb-6">
                <button id="btn-online" onclick="toggleOnline()" class="flex-1 bg-white border border-gray-200 py-3 rounded-2xl text-xs font-bold shadow-sm transition-all active:bg-gray-50">ğŸ›µ ç‡Ÿæ¥­ä¸­</button>
                <button onclick="openFilter()" class="flex-1 bg-blue-600 text-white py-3 rounded-2xl text-xs font-bold shadow-lg active:bg-blue-700"><i class="fa-solid fa-sliders mr-2"></i>ç¯©é¸è¨­å®š</button>
            </div>

            <div id="restaurant-list" class="space-y-4">
                </div>
        </section>

        <section id="tab-gacha" class="tab-content p-6 text-center">
            <h2 class="text-2xl font-black mt-10">æŠ½ç±¤æ±ºå®šï¼</h2>
            <p class="text-xs text-gray-400 mb-10 tracking-widest">è§£æ±ºæ‚¨çš„é¸æ“‡å›°é›£ç—‡</p>
            
            <div id="gacha-box" onclick="goToLuckyRes()" class="w-full h-56 bg-white border-4 border-blue-500 rounded-[40px] shadow-2xl flex flex-col items-center justify-center p-8 mb-10 cursor-pointer active:scale-95 transition-all">
                <div id="gacha-result-name" class="text-3xl font-black text-blue-600 mb-2">? ? ?</div>
                <div id="gacha-result-sub" class="text-sm text-gray-400 font-medium italic">é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹</div>
                <div id="gacha-click-hint" class="hidden mt-4 text-[10px] bg-blue-600 text-white px-4 py-1.5 rounded-full">é»æ­¤é–‹å•Ÿå°èˆª â”</div>
            </div>
            
            <div class="space-y-6">
                <p class="text-xs text-gray-500 font-bold">ä»Šæ—¥é¤˜é¡: <span id="draw-count" class="text-blue-600 text-lg">3</span> / 3</p>
                <button id="btn-draw" onclick="handleDraw()" class="w-full bg-gray-900 text-white py-5 rounded-3xl font-black shadow-xl active:scale-95 transition">éš¨æ©Ÿæ¨è–¦</button>
                <div id="snarky-text" class="text-red-500 text-[10px] font-bold opacity-0 transition-opacity">å°±ä½ å•æœ€å¤š ğŸ™„</div>
            </div>
        </section>

        <section id="tab-group" class="tab-content p-4">
            <h2 class="text-xl font-black mb-6">åŒäº‹æªåœ˜</h2>
            <div class="bg-white p-10 rounded-[30px] text-center border-2 border-dashed border-gray-200">
                <p class="text-sm text-gray-400">é€™æ˜¯ä¸€å€‹å¤¢æƒ³çš„é–‹å§‹...<br>è³‡æ–™åº«é€£å‹•é–‹ç™¼ä¸­</p>
            </div>
        </section>
    </main>

    <div id="filter-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-end">
        <div class="bg-white w-full rounded-t-[40px] p-8 pb-12 animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-xl">æƒ³åƒä»€éº¼ï¼Ÿ</h3>
                <button onclick="resetFilters()" class="text-xs text-blue-500 font-bold">é‡è¨­</button>
            </div>
            
            <div class="mb-6">
                <div class="flex flex-wrap gap-2" id="type-tags">
                    <button onclick="toggleTypeTag(this, 'ä¸­å¼')" class="px-4 py-2 rounded-xl border bg-gray-50 text-xs font-bold">ä¸­å¼</button>
                    <button onclick="toggleTypeTag(this, 'æ—¥å¼')" class="px-4 py-2 rounded-xl border bg-gray-50 text-xs font-bold">æ—¥å¼</button>
                    <button onclick="toggleTypeTag(this, 'è¥¿å¼')" class="px-4 py-2 rounded-xl border bg-gray-50 text-xs font-bold">è¥¿å¼</button>
                    <button onclick="toggleTypeTag(this, 'ç”œé»')" class="px-4 py-2 rounded-xl border bg-gray-50 text-xs font-bold">ç”œé»</button>
                    <button onclick="toggleTypeTag(this, 'å¥åº·')" class="px-4 py-2 rounded-xl border bg-gray-50 text-xs font-bold">å¥åº·é¤</button>
                </div>
            </div>

            <button onclick="applyFilters()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black shadow-lg">å¥—ç”¨æœå°‹</button>
        </div>
    </div>

    <nav class="bg-white border-t border-gray-100 flex justify-around items-center h-20 pb-6 flex-shrink-0 z-50">
        <button onclick="switchTab('recommend')" id="nav-recommend" class="flex flex-col items-center gap-1 active-nav flex-1"><i class="fa-solid fa-map-pin text-xl"></i><span class="text-[10px] font-bold">é™„è¿‘</span></button>
        <button onclick="switchTab('gacha')" id="nav-gacha" class="flex flex-col items-center gap-1 flex-1"><i class="fa-solid fa-dice text-xl"></i><span class="text-[10px] font-bold">éš¨æ©Ÿ</span></button>
        <button onclick="switchTab('group')" id="nav-group" class="flex flex-col items-center gap-1 flex-1"><i class="fa-solid fa-users text-xl"></i><span class="text-[10px] font-bold">æªåœ˜</span></button>
    </nav>

    <script>
        const ZEABUR_URL = "https://lunch-go.zeabur.app"; 
        let allPlaces = [], drawLimit = 3, isOnlineOnly = false;
        let currentLat, currentLng, luckyPlace = null;
        let selectedTypes = [];

        // é¡å‹æ¨™ç±¤å°æ‡‰ Google Place Types
        const googleTypeMap = {
            'ä¸­å¼': ['restaurant', 'food'],
            'æ—¥å¼': ['sushi', 'japanese_restaurant'],
            'è¥¿å¼': ['pizza_restaurant', 'hamburger_restaurant', 'italian_restaurant', 'steak_house'],
            'ç”œé»': ['bakery', 'cafe', 'dessert_shop'],
            'å¥åº·': ['health_food', 'vegan_restaurant']
        };

        window.onload = () => {
            document.getElementById('user-id').innerText = `#User${Math.floor(Math.random()*899)+100}`;
            initLocation();
        };

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('active-nav'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.getElementById(`nav-${tabId}`).classList.add('active-nav');
        }

        function initLocation() {
            navigator.geolocation.getCurrentPosition(pos => {
                currentLat = pos.coords.latitude;
                currentLng = pos.coords.longitude;
                fetchData();
            });
        }

        // è¨ˆç®—è·é›¢ (Haversine Formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return (R * c).toFixed(1);
        }

        async function fetchData() {
            const listEl = document.getElementById('restaurant-list');
            listEl.innerHTML = `<div class="text-center py-20 animate-bounce text-blue-500 font-bold">ğŸ³ æ­£åœ¨ç‚ºæ‚¨ç¿»æ‰¾ç¾å‘³...</div>`;
            
            // æ“´å¤§åŠå¾‘è‡³ 3000m
            let url = `${ZEABUR_URL}/api/restaurants?lat=${currentLat}&lng=${currentLng}&radius=3000`;
            if (selectedTypes.length > 0) url += `&keyword=${encodeURIComponent(selectedTypes.join(' '))}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.status === "OK") {
                    allPlaces = data.results.map(p => ({
                        ...p,
                        distance: calculateDistance(currentLat, currentLng, p.geometry.location.lat, p.geometry.location.lng)
                    }));
                    // ä¾è·é›¢æ’åº
                    allPlaces.sort((a, b) => a.distance - b.distance);
                    renderList();
                }
            } catch (err) { listEl.innerHTML = `<p class="text-center text-red-400">é€£ç·šå¤±æ•—</p>`; }
        }

        function renderList() {
            let filtered = isOnlineOnly ? allPlaces.filter(p => p.opening_hours?.open_now) : allPlaces;
            const listEl = document.getElementById('restaurant-list');
            
            if (filtered.length === 0) {
                listEl.innerHTML = `<div class="text-center py-20 text-gray-400 italic">é€™å€æ˜¯ç¾é£Ÿæ²™æ¼ å—ï¼Ÿæ›å€‹æ¢ä»¶è©¦è©¦ ğŸœï¸</div>`;
                return;
            }

            listEl.innerHTML = filtered.map(place => `
                <div class="res-card bg-white rounded-3xl p-5 shadow-sm border border-gray-100 flex flex-col gap-3 relative overflow-hidden" onclick="openMaps('${place.name}', '${place.place_id}')">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-black text-lg text-gray-800 leading-tight">${place.name}</h4>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="bg-yellow-400 text-white text-[10px] px-2 py-0.5 rounded-lg font-black">â˜… ${place.rating || 'æ–°é€²'}</span>
                                <span class="text-blue-500 text-[10px] font-bold">ğŸ“ è·é›¢ ${place.distance} km</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] ${place.opening_hours?.open_now ? 'text-green-500' : 'text-red-400'} font-black uppercase">
                                ${place.opening_hours?.open_now ? 'â— ç‡Ÿæ¥­ä¸­' : 'â— å·²æ‰“çƒŠ'}
                            </div>
                        </div>
                    </div>
                    <div class="text-[10px] text-gray-400 font-medium truncate italic"><i class="fa-solid fa-location-dot mr-1"></i>${place.vicinity}</div>
                </div>
            `).join('');
        }

        function openMaps(name, id) { window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}&query_place_id=${id}`); }

        function toggleTypeTag(btn, type) {
            btn.classList.toggle('tag-selected');
            if (selectedTypes.includes(type)) { selectedTypes = selectedTypes.filter(t => t !== type); } 
            else { selectedTypes.push(type); }
        }

        function openFilter() { document.getElementById('filter-modal').classList.remove('hidden'); }
        function closeFilter() { document.getElementById('filter-modal').classList.add('hidden'); }
        function applyFilters() { closeFilter(); fetchData(); }
        function resetFilters() {
            selectedTypes = [];
            document.querySelectorAll('.tag-selected').forEach(el => el.classList.remove('tag-selected'));
        }

        function toggleOnline() {
            isOnlineOnly = !isOnlineOnly;
            document.getElementById('btn-online').classList.toggle('tag-selected');
            renderList();
        }

        // æŠ½ç±¤åŠŸèƒ½ä¿®æ­£
        function handleDraw() {
            if (drawLimit <= 0 || allPlaces.length === 0) return;
            const box = document.getElementById('gacha-box');
            const nameEl = document.getElementById('gacha-result-name');
            const subEl = document.getElementById('gacha-result-sub');
            const hintEl = document.getElementById('gacha-click-hint');

            box.classList.add('shaking');
            nameEl.innerText = "ğŸ² è½‰å‹•ä¸­";
            subEl.innerText = "å¥½é‹é™è‡¨ä¸­...";

            setTimeout(() => {
                box.classList.remove('shaking');
                drawLimit--;
                document.getElementById('draw-count').innerText = drawLimit;
                luckyPlace = allPlaces[Math.floor(Math.random() * allPlaces.length)];
                
                nameEl.innerText = luckyPlace.name;
                subEl.innerText = `è·é›¢æ‚¨ç´„ ${luckyPlace.distance} å…¬é‡Œ`;
                hintEl.classList.remove('hidden');
                
                if(drawLimit === 0) {
                    document.getElementById('btn-draw').disabled = true;
                    document.getElementById('btn-draw').classList.add('bg-gray-300');
                    document.getElementById('snarky-text').style.opacity = "1";
                }
            }, 1000);
        }

        function goToLuckyRes() { if (luckyPlace) openMaps(luckyPlace.name, luckyPlace.place_id); }
    </script>
</body>
</html>