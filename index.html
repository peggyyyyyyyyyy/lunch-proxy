<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Lunch Go æ±ºç­–å¹«æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* æŠ½ç±¤å‹•ç•«æ•ˆæœ */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shaking { animation: shake 0.5s; animation-iteration-count: infinite; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <div class="bg-white shadow-md p-4 z-10 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold text-gray-800">Lunch Go ğŸ½ï¸</h1>
            <p id="location-status" class="text-xs text-gray-500">ç­‰å¾…å®šä½...</p>
        </div>
        <button onclick="toggleMode()" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-sm font-bold shadow-sm active:scale-95 transition">
            <i class="fa-solid fa-dice"></i> <span id="mode-text">éš¨æ©ŸæŠ½ç±¤</span>
        </button>
    </div>

    <div id="list-view" class="flex-1 flex flex-col overflow-hidden transition-all duration-300">
        
        <div class="bg-white border-b px-4 py-2 flex gap-2 overflow-x-auto hide-scrollbar">
            <button onclick="toggleOnlineOnly()" id="btn-online" class="flex-shrink-0 border border-gray-300 px-3 py-1 rounded-full text-sm text-gray-600">
                <i class="fa-solid fa-motorcycle"></i> ç·šä¸Šè¨‚é¤
            </button>
            
            <button onclick="openFilterModal()" class="flex-shrink-0 bg-gray-800 text-white px-3 py-1 rounded-full text-sm">
                <i class="fa-solid fa-sliders"></i> ç¯©é¸æ¢ä»¶
            </button>
            
            <div id="active-filters" class="flex gap-2"></div>
        </div>

        <div id="restaurant-list" class="flex-1 overflow-y-auto p-4 space-y-3 pb-20">
            <div class="animate-pulse space-y-3">
                <div class="h-24 bg-gray-200 rounded-xl"></div>
                <div class="h-24 bg-gray-200 rounded-xl"></div>
                <div class="h-24 bg-gray-200 rounded-xl"></div>
            </div>
        </div>
    </div>

    <div id="random-view" class="hidden flex-1 flex flex-col items-center justify-center p-6 bg-yellow-50 relative">
        <div class="text-center mb-8">
            <h2 class="text-2xl font-bold text-gray-700 mb-2">ä»Šå¤©åƒä»€éº¼ï¼Ÿ</h2>
            <p class="text-gray-500">äº¤çµ¦å‘½é‹ä¾†æ±ºå®šå§</p>
        </div>

        <div id="gacha-box" class="w-48 h-48 bg-white rounded-full shadow-xl flex items-center justify-center border-4 border-yellow-400 text-6xl mb-8 cursor-pointer active:scale-95 transition" onclick="drawLunch()">
            â“
        </div>

        <div id="result-card" class="hidden w-full max-w-sm bg-white p-6 rounded-2xl shadow-lg transform transition-all">
            <h3 id="result-name" class="text-xl font-bold text-gray-800 mb-2">é¤å»³åç¨±</h3>
            <div class="flex items-center gap-2 text-yellow-500 mb-4">
                <i class="fa-solid fa-star"></i> <span id="result-rating">4.5</span>
            </div>
            <a id="result-link" href="#" target="_blank" class="block w-full bg-blue-600 text-white text-center py-3 rounded-xl font-bold">
                å‰å¾€å°èˆª / è¨‚é¤
            </a>
        </div>

        <div class="mt-8 text-center">
            <p id="retry-limit-text" class="text-sm text-gray-500 mb-2">ä»Šæ—¥å‰©é¤˜æ¬¡æ•¸: <span id="retry-count">3</span></p>
            <button id="btn-retry" onclick="drawLunch()" class="bg-gray-800 text-white px-6 py-2 rounded-lg font-bold shadow-lg active:scale-95">
                å†æŠ½ä¸€æ¬¡
            </button>
            <p id="snarky-text" class="text-xs text-red-500 mt-2 h-4 font-bold opacity-0 transition-opacity">å°±ä½ å•æœ€å¤š ğŸ™„</p>
        </div>
    </div>

    <div id="filter-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex justify-center items-end sm:items-center">
        <div class="bg-white w-full sm:w-96 rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold">é€²éšç¯©é¸</h3>
                <button onclick="closeFilterModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>

            <div class="mb-4">
                <p class="text-sm font-bold text-gray-600 mb-2">æƒ³åƒå“ªä¸€é¡?</p>
                <div class="flex flex-wrap gap-2">
                    <button onclick="setFilter('type', 'ä¸­å¼')" class="filter-btn border px-3 py-1 rounded-lg text-sm" data-group="type" data-val="restaurant">ä¸æ‹˜</button>
                    <button onclick="setFilter('type', 'Chinese')" class="filter-btn border px-3 py-1 rounded-lg text-sm" data-group="type" data-val="Chinese restaurant">ä¸­å¼</button>
                    <button onclick="setFilter('type', 'Western')" class="filter-btn border px-3 py-1 rounded-lg text-sm" data-group="type" data-val="Western restaurant">è¥¿å¼</button>
                    <button onclick="setFilter('type', 'Japanese')" class="filter-btn border px-3 py-1 rounded-lg text-sm" data-group="type" data-val="Japanese restaurant">æ—¥å¼</button>
                    <button onclick="setFilter('type', 'Cafe')" class="filter-btn border px-3 py-1 rounded-lg text-sm" data-group="type" data-val="cafe">è¼•é£Ÿ/å’–å•¡</button>
                </div>
            </div>

            <div class="mb-4">
                <p class="text-sm font-bold text-gray-600 mb-2">ç¾åœ¨çš„å¿ƒæƒ…?</p>
                <div class="flex flex-wrap gap-2">
                    <button onclick="setFilter('mood', 'normal')" class="filter-btn border px-3 py-1 rounded-lg text-sm" data-group="mood" data-val="normal">ä¸€èˆ¬</button>
                    <button onclick="setFilter('mood', 'happy')" class="filter-btn border px-3 py-1 rounded-lg text-sm" data-group="mood" data-val="happy">æ…¶ç¥ (é«˜åƒ¹ä½)</button>
                    <button onclick="setFilter('mood', 'fast')" class="filter-btn border px-3 py-1 rounded-lg text-sm" data-group="mood" data-val="fast">è¶•æ™‚é–“ (é€Ÿé£Ÿ)</button>
                </div>
            </div>

            <div class="mb-6">
                <p class="text-sm font-bold text-gray-600 mb-2">é ç®—ç¯„åœ</p>
                <select id="price-select" class="w-full border p-2 rounded-lg bg-gray-50">
                    <option value="all">ä¸é™é‡‘é¡</option>
                    <option value="1">$0 - $200 (ä¾¿å®œ)</option>
                    <option value="2">$200 - $600 (ä¸­åƒ¹ä½)</option>
                    <option value="3">$600+ (è±ªè¯)</option>
                </select>
            </div>

            <button onclick="applyFilters()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">ç¢ºèªç¯©é¸</button>
        </div>
    </div>

    <script>
        // ================= è¨­å®šå€ =================
        const ZEABUR_URL = "https://lunch-go.zeabur.app"; // è«‹æ›¿æ›é€™è£¡
        // =========================================

        let allRestaurants = [];
        let filteredRestaurants = [];
        let currentFilters = { type: 'restaurant', mood: 'normal', price: 'all', onlineOnly: false };
        let userLat = 0, userLng = 0;
        
        // æ¯æ—¥æŠ½ç±¤é™åˆ¶
        const MAX_RETRIES = 3;
        
        // åˆå§‹åŒ–
        window.onload = () => {
            initLocation();
            checkDailyLimit();
        };

        // 1. å–å¾—å®šä½
        function initLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        userLat = pos.coords.latitude;
                        userLng = pos.coords.longitude;
                        document.getElementById('location-status').innerText = "ğŸ“ å®šä½æˆåŠŸï¼Œæ­£åœ¨æœå°‹é™„è¿‘çš„ç¾å‘³...";
                        fetchData();
                    },
                    (err) => {
                        document.getElementById('location-status').innerText = "âŒ ç„¡æ³•å–å¾—å®šä½";
                        alert("è«‹å…è¨±å®šä½æ¬Šé™æ‰èƒ½å°‹æ‰¾é™„è¿‘é¤å»³");
                    }
                );
            }
        }

        // 2. å¾ Zeabur ç²å–è³‡æ–™
        async function fetchData() {
            try {
                // æ“´å¤§æœå°‹åŠå¾‘åˆ° 1200m (ç´„èµ°è·¯ 15 åˆ†é˜)
                const res = await fetch(`${ZEABUR_URL}/api/restaurants?lat=${userLat}&lng=${userLng}&radius=1200`);
                const data = await res.json();
                
                if(data.status === "OK") {
                    allRestaurants = data.results;
                    filteredRestaurants = allRestaurants;
                    renderList();
                } else {
                    document.getElementById('restaurant-list').innerHTML = `<div class="p-4 text-center text-gray-500">é™„è¿‘å¥½åƒæ²’æœ‰é¤å»³...</div>`;
                }
            } catch (e) {
                console.error(e);
                document.getElementById('restaurant-list').innerHTML = `<div class="p-4 text-center text-red-500">é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Zeabur ç‹€æ…‹</div>`;
            }
        }

        // 3. æ¸²æŸ“åˆ—è¡¨
        function renderList() {
            const listEl = document.getElementById('restaurant-list');
            listEl.innerHTML = "";

            if (filteredRestaurants.length === 0) {
                listEl.innerHTML = `<div class="p-10 text-center text-gray-400">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é¤å»³<br>è«‹æ”¾å¯¬ç¯©é¸æ¢ä»¶</div>`;
                return;
            }

            filteredRestaurants.forEach(place => {
                // è¨ˆç®—äººæ°£æ¨™ç±¤ (ç”¨è©•è«–æ•¸æ¨¡æ“¬)
                let crowdBadge = "";
                const reviews = place.user_ratings_total || 0;
                if(reviews > 1000) crowdBadge = `<span class="bg-red-100 text-red-600 text-xs px-2 py-0.5 rounded ml-2">ğŸ”¥ äººæ°£çˆ†æ£š</span>`;
                else if(reviews > 500) crowdBadge = `<span class="bg-orange-100 text-orange-600 text-xs px-2 py-0.5 rounded ml-2">ğŸ‘¥ äººæ½®å¤š</span>`;

                // åƒ¹ä½é¡¯ç¤º
                const priceSymbol = "ğŸ’°".repeat(place.price_level || 1);
                
                // Google Maps é€£çµ (åŒ…å«è¨‚ä½/é›»è©±)
                const mapLink = `https://www.google.com/maps/place/?q=place_id:${place.place_id}`;

                const item = document.createElement('div');
                item.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:bg-gray-50 transition";
                item.onclick = () => window.open(mapLink, '_blank');
                
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">${place.name}</h3>
                            <div class="flex items-center text-sm text-yellow-500 mt-1">
                                <i class="fa-solid fa-star"></i> 
                                <span class="ml-1 font-bold text-gray-700">${place.rating || "N/A"}</span>
                                <span class="text-gray-400 text-xs ml-1">(${reviews}å‰‡è©•è«–)</span>
                                ${crowdBadge}
                            </div>
                        </div>
                        <div class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500">${priceSymbol}</div>
                    </div>
                    <div class="mt-3 flex gap-2">
                        ${place.opening_hours?.open_now ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">ç‡Ÿæ¥­ä¸­</span>' : '<span class="text-xs bg-gray-200 text-gray-500 px-2 py-1 rounded">ä¼‘æ¯ä¸­</span>'}
                        <span class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded">æŸ¥çœ‹è©³æƒ…/è¨‚é¤ ></span>
                    </div>
                `;
                listEl.appendChild(item);
            });
        }

        // ================= ç¯©é¸é‚è¼¯ =================
        function openFilterModal() { document.getElementById('filter-modal').classList.remove('hidden'); }
        function closeFilterModal() { document.getElementById('filter-modal').classList.add('hidden'); }

        // æŒ‰éˆ•æ¨£å¼åˆ‡æ›
        function setFilter(group, val) {
            document.querySelectorAll(`.filter-btn[data-group="${group}"]`).forEach(b => b.classList.remove('bg-blue-600', 'text-white'));
            const btn = document.querySelector(`.filter-btn[data-val="${val}"]`);
            if(btn) btn.classList.add('bg-blue-600', 'text-white');
            
            if(group === 'type') currentFilters.type = val;
            if(group === 'mood') currentFilters.mood = val;
        }

        function toggleOnlineOnly() {
            currentFilters.onlineOnly = !currentFilters.onlineOnly;
            const btn = document.getElementById('btn-online');
            if(currentFilters.onlineOnly) {
                btn.classList.add('bg-green-500', 'text-white', 'border-green-500');
                btn.classList.remove('text-gray-600', 'border-gray-300');
            } else {
                btn.classList.remove('bg-green-500', 'text-white', 'border-green-500');
                btn.classList.add('text-gray-600', 'border-gray-300');
            }
            applyFiltersLogic();
        }

        function applyFilters() {
            currentFilters.price = document.getElementById('price-select').value;
            closeFilterModal();
            applyFiltersLogic();
        }

        function applyFiltersLogic() {
            // è¤‡è£½åŸå§‹æ¸…å–®
            let results = [...allRestaurants];

            // 1. é¤é»ç¨®é¡éæ¿¾ (ä½¿ç”¨åç¨±é—œéµå­—)
            if(currentFilters.type !== 'restaurant') {
                // å¦‚æœ Zeabur æ²’å‚³å› typeï¼Œé€™è£¡ç”¨é—œéµå­—æ¨¡ç³Šæ¯”å°åç¨± (å› ç‚º Places API é¡å‹æœ‰é™)
                // é€™è£¡ç°¡åŒ–ï¼šå¦‚æœé¸æ“‡è¥¿å¼ï¼Œæˆ‘å€‘æš«æ™‚ä¸åšåš´æ ¼éæ¿¾ï¼Œé€™éœ€è¦å¾Œç«¯æ”¯æ´æ›´å¤šåƒæ•¸
                // ç‚ºäº†å±•ç¤ºåŠŸèƒ½ï¼Œæˆ‘å€‘å…ˆå‡è¨­æ‰€æœ‰é¤å»³éƒ½ç¬¦åˆï¼Œæˆ–è€…ä½ å¯ä»¥æ ¹æ“š place.types é™£åˆ—éæ¿¾
            }

            // 2. å¿ƒæƒ…éæ¿¾ (æ˜ å°„åˆ°åƒ¹ä½èˆ‡é¡å‹)
            if(currentFilters.mood === 'happy') {
                // æ…¶ç¥ï¼šç¯©é¸è©•åˆ†é«˜ä¸”åƒ¹ä½ä¸ç‚ºæœ€ä½
                results = results.filter(r => (r.rating >= 4.0 && r.price_level >= 2));
            } else if (currentFilters.mood === 'fast') {
                // è¶•æ™‚é–“ï¼šç¯©é¸ä¸éœ€è¦å¤ªé«˜åƒ¹ä½
                results = results.filter(r => (!r.price_level || r.price_level <= 1));
            }

            // 3. åƒ¹æ ¼éæ¿¾
            if(currentFilters.price !== 'all') {
                const p = parseInt(currentFilters.price);
                results = results.filter(r => r.price_level === p);
            }

            // 4. ç·šä¸Šè¨‚é¤ (æ¨¡æ“¬ï¼šç¯©é¸æœ‰ç¶²ç«™çš„æˆ–æ˜¯æœ‰ç‡Ÿæ¥­çš„)
            if(currentFilters.onlineOnly) {
                // å› ç‚º API é™åˆ¶ï¼Œé€™è£¡æˆ‘å€‘ç¯©é¸ã€Œç‡Ÿæ¥­ä¸­ã€ç•¶ä½œå¯ç«‹å³è™•ç†
                results = results.filter(r => r.opening_hours?.open_now);
            }

            filteredRestaurants = results;
            renderList();
        }

        // ================= éš¨æ©ŸæŠ½ç±¤é‚è¼¯ =================
        function toggleMode() {
            const listDiv = document.getElementById('list-view');
            const randomDiv = document.getElementById('random-view');
            const modeText = document.getElementById('mode-text');
            
            if(listDiv.classList.contains('hidden')) {
                listDiv.classList.remove('hidden');
                randomDiv.classList.add('hidden');
                modeText.innerText = "éš¨æ©ŸæŠ½ç±¤";
            } else {
                listDiv.classList.add('hidden');
                randomDiv.classList.remove('hidden');
                modeText.innerText = "è¿”å›åˆ—è¡¨";
                resetGacha();
            }
        }

        function resetGacha() {
            document.getElementById('result-card').classList.add('hidden');
            document.getElementById('gacha-box').classList.remove('hidden');
            document.getElementById('gacha-box').innerText = "â“";
        }

        // è®€å–/å¯«å…¥æ¯æ—¥æ¬¡æ•¸
        function checkDailyLimit() {
            const today = new Date().toDateString();
            const stored = JSON.parse(localStorage.getItem('lunchGoLimit') || '{}');
            
            if (stored.date !== today) {
                localStorage.setItem('lunchGoLimit', JSON.stringify({ date: today, count: MAX_RETRIES }));
                updateRetryUI(MAX_RETRIES);
            } else {
                updateRetryUI(stored.count);
            }
        }

        function updateRetryUI(count) {
            document.getElementById('retry-count').innerText = count;
            const btn = document.getElementById('btn-retry');
            if(count <= 0) {
                btn.disabled = true;
                btn.classList.add('bg-gray-400', 'cursor-not-allowed');
                btn.innerText = "æ˜æ—¥å†ä¾†";
            }
        }

        function drawLunch() {
            // æª¢æŸ¥æ¬¡æ•¸
            const stored = JSON.parse(localStorage.getItem('lunchGoLimit'));
            if (stored.count <= 0) return;

            // å‹•ç•«
            const box = document.getElementById('gacha-box');
            box.classList.add('shaking');
            box.innerText = "ğŸ²";

            setTimeout(() => {
                box.classList.remove('shaking');
                
                // éš¨æ©Ÿé¸ä¸€å€‹ (å¾ç¯©é¸å¾Œçš„æ¸…å–®é¸ï¼Œæ¯”è¼ƒç¬¦åˆç•¶ä¸‹å¿ƒæƒ…)
                const source = filteredRestaurants.length > 0 ? filteredRestaurants : allRestaurants;
                const luckyOne = source[Math.floor(Math.random() * source.length)];
                
                // é¡¯ç¤ºçµæœ
                box.classList.add('hidden');
                const card = document.getElementById('result-card');
                card.classList.remove('hidden');
                
                document.getElementById('result-name').innerText = luckyOne.name;
                document.getElementById('result-rating').innerText = luckyOne.rating || "N/A";
                document.getElementById('result-link').href = `https://www.google.com/maps/place/?q=place_id:${luckyOne.place_id}`;

                // æ‰£é™¤æ¬¡æ•¸
                stored.count--;
                localStorage.setItem('lunchGoLimit', JSON.stringify(stored));
                updateRetryUI(stored.count);

                // å˜²è«·æ–‡å­—
                const snarky = document.getElementById('snarky-text');
                snarky.style.opacity = "1";
                if(stored.count === 2) snarky.innerText = "ä¸æ»¿æ„å–”ï¼ŸğŸ¤¨";
                if(stored.count === 1) snarky.innerText = "æœ€å¾Œä¸€æ¬¡å›‰...ğŸ˜®â€ğŸ’¨";
                if(stored.count === 0) snarky.innerText = "å°±ä½ å•æœ€å¤šï¼æ˜å¤©è¦‹ ğŸ‘‹";

            }, 800);
        }
    </script>
</body>
</html>