<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lunch Go! ä¼æ¥­ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ä¿®æ­£è·‘ç‰ˆèˆ‡æ²è»¸ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .active-nav { color: #3b82f6; border-top: 3px solid #3b82f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* æŠ½ç±¤éœ‡å‹•æ•ˆæœ (å–ä»£æ—‹è½‰) */
        @keyframes shake {
            0% { transform: translate(1px, 1px); }
            20% { transform: translate(-3px, 0px); }
            40% { transform: translate(1px, -1px); }
            60% { transform: translate(-3px, 1px); }
            80% { transform: translate(-1px, -1px); }
            100% { transform: translate(1px, 1px); }
        }
        .shaking { animation: shake 0.2s infinite; }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col overflow-hidden">

    <header class="bg-white p-4 shadow-sm flex justify-between items-center flex-shrink-0">
        <h1 class="text-xl font-black text-blue-600 italic">LUNCH GO!</h1>
        <div id="user-badge" class="flex items-center gap-2">
            <span class="text-[10px] bg-blue-50 text-blue-500 px-2 py-1 rounded-full font-bold">åŒ¿å ID: #User${Math.floor(Math.random()*899)+100}</span>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto no-scrollbar pb-20">
        
        <section id="tab-recommend" class="tab-content active p-4">
            <div id="location-status" class="text-xs text-gray-400 mb-3 text-center italic">æ­£åœ¨å®šä½æ‚¨çš„åˆé¤ç¯„åœ...</div>
            
            <div class="bg-white rounded-2xl p-4 shadow-sm mb-4">
                <p class="text-[10px] font-bold text-gray-400 mb-3 uppercase tracking-tighter">ç•¶ä¸‹æƒ…ç·’å°æ‡‰æœå°‹</p>
                <div class="flex justify-between items-center">
                    <button onclick="filterByMood('happy')" class="flex flex-col items-center gap-1 group">
                        <span class="text-3xl group-active:scale-90 transition">ğŸ˜Š</span>
                        <span class="text-[10px] text-gray-400">é–‹å¿ƒ</span>
                    </button>
                    <button onclick="filterByMood('sad')" class="flex flex-col items-center gap-1 group">
                        <span class="text-3xl group-active:scale-90 transition">ğŸ˜¢</span>
                        <span class="text-[10px] text-gray-400">é›£é</span>
                    </button>
                    <button onclick="filterByMood('angry')" class="flex flex-col items-center gap-1 group">
                        <span class="text-3xl group-active:scale-90 transition">ğŸ’¢</span>
                        <span class="text-[10px] text-gray-400">ç”Ÿæ°£</span>
                    </button>
                    <button onclick="filterByMood('fit')" class="flex flex-col items-center gap-1 group">
                        <span class="text-3xl group-active:scale-90 transition">ğŸ’ª</span>
                        <span class="text-[10px] text-gray-400">å¥èº«</span>
                    </button>
                    <button onclick="filterByMood('nervous')" class="flex flex-col items-center gap-1 group">
                        <span class="text-3xl group-active:scale-90 transition">ğŸ·</span>
                        <span class="text-[10px] text-gray-400">ç·Šå¼µ</span>
                    </button>
                </div>
            </div>

            <div class="flex gap-2 mb-4">
                <button onclick="toggleOnline()" id="btn-online" class="flex-1 bg-white border border-gray-200 py-2 rounded-xl text-xs font-bold shadow-sm active:bg-blue-50 transition">ğŸ›µ ç·šä¸Šè¨‚é¤å„ªå…ˆ</button>
                <button onclick="fetchData()" class="px-4 bg-white border border-gray-200 py-2 rounded-xl text-xs shadow-sm active:bg-gray-100"><i class="fa-solid fa-rotate-right"></i></button>
            </div>

            <div id="restaurant-list" class="space-y-3">
                <div class="animate-pulse bg-white h-24 rounded-2xl"></div>
                <div class="animate-pulse bg-white h-24 rounded-2xl"></div>
            </div>
        </section>

        <section id="tab-gacha" class="tab-content p-6 text-center">
            <h2 class="text-2xl font-black text-gray-800 mt-10">æŠ½ç±¤æ±ºå®šï¼</h2>
            <p class="text-sm text-gray-400 mb-10">ä»Šå¤©åƒä»€éº¼ï¼Œå•å¤©å•å¤§åœ°</p>
            
            <div id="gacha-box" class="w-48 h-48 bg-white border-4 border-blue-500 rounded-3xl mx-auto shadow-2xl flex items-center justify-center text-6xl mb-10 transition-all">
                â“
            </div>
            
            <div class="space-y-4">
                <p class="text-xs text-gray-400">ä»Šæ—¥å‰©é¤˜æ¬¡æ•¸: <span id="draw-count" class="font-bold text-blue-600 text-lg">3</span> / 3</p>
                <button id="btn-draw" onclick="handleDraw()" class="w-full max-w-xs bg-blue-600 text-white py-4 rounded-2xl font-black shadow-lg active:scale-95 transition disabled:bg-gray-300">
                    å¹«æˆ‘æŠ½ä¸€å€‹ï¼
                </button>
                <div id="snarky-text" class="text-red-500 text-xs font-bold opacity-0 transition-opacity">å°±ä½ å•æœ€å¤š ğŸ™„</div>
            </div>

            <div id="draw-result-card" class="hidden mt-6 bg-yellow-50 p-4 rounded-2xl border-2 border-yellow-200 animate-bounce">
                <p class="text-[10px] text-yellow-600 font-bold uppercase tracking-widest">ä¸­çé¤å»³</p>
                <h3 id="res-name" class="text-xl font-bold text-gray-800 my-1">---</h3>
                <p id="res-rating" class="text-sm text-gray-500">â­ --</p>
            </div>
        </section>

        <section id="tab-group" class="tab-content p-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black text-gray-800">åŒäº‹æªåœ˜å€</h2>
                <button class="bg-orange-500 text-white px-4 py-2 rounded-xl text-xs font-bold">+ æˆ‘è¦ç™¼èµ·</button>
            </div>
            
            <div class="space-y-4">
                <div class="bg-white p-5 rounded-2xl shadow-sm border-l-8 border-orange-500">
                    <div class="flex justify-between items-center mb-2">
                        <span class="bg-orange-100 text-orange-600 text-[10px] px-2 py-1 rounded font-bold italic">å³å°‡æˆªæ­¢ 11:30</span>
                        <span class="text-xs text-gray-400 italic">#User402 ç™¼èµ·</span>
                    </div>
                    <h3 class="font-bold text-lg text-gray-800">å¤§å®¶ä¸€èµ·è¨‚ [å¥åº·é¤ç›’]</h3>
                    <p class="text-xs text-gray-500 mb-4">é€™å®¶å¥åº·é¤å¾ˆå¥½åƒï¼Œæ»¿ 500 å…é‹è²»ï¼</p>
                    <div class="flex justify-between items-center">
                        <div class="flex -space-x-2">
                            <div class="w-6 h-6 rounded-full bg-blue-200 border-2 border-white"></div>
                            <div class="w-6 h-6 rounded-full bg-green-200 border-2 border-white"></div>
                            <div class="text-xs text-gray-400 self-center ml-4">+3 äººå·²åŠ å…¥</div>
                        </div>
                        <button class="bg-blue-600 text-white px-5 py-2 rounded-xl text-xs font-bold">+1 åŠ å…¥</button>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <nav class="bg-white border-t border-gray-100 flex justify-around items-center h-20 pb-4 flex-shrink-0 z-50">
        <button onclick="switchTab('recommend')" id="nav-recommend" class="flex flex-col items-center gap-1 active-nav flex-1">
            <i class="fa-solid fa-utensils text-xl"></i><span class="text-[10px] font-bold">é™„è¿‘æ¨è–¦</span>
        </button>
        <button onclick="switchTab('gacha')" id="nav-gacha" class="flex flex-col items-center gap-1 flex-1">
            <i class="fa-solid fa-dice text-xl"></i><span class="text-[10px] font-bold">éš¨æ©ŸæŠ½ç±¤</span>
        </button>
        <button onclick="switchTab('group')" id="nav-group" class="flex flex-col items-center gap-1 flex-1">
            <i class="fa-solid fa-users-viewfinder text-xl"></i><span class="text-[10px] font-bold">åŒäº‹æªåœ˜</span>
        </button>
    </nav>

    <script>
        const ZEABUR_URL = "https://lunch-go.zeabur.app"; // è¨˜å¾—æ›´æ›ï¼
        let allPlaces = [];
        let drawLimit = 3;

        // 1. åˆå§‹åŒ–
        window.onload = () => {
            initLocation();
        };

        // 2. é ç±¤åˆ‡æ›é‚è¼¯
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('active-nav'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.getElementById(`nav-${tabId}`).classList.add('active-nav');
        }

        // 3. å®šä½åŠŸèƒ½
        function initLocation() {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const { latitude, longitude } = pos.coords;
                    document.getElementById('location-status').innerText = "ğŸ“ å·²é–å®šé™„è¿‘ 20 åˆ†é˜æ­¥è¡Œè·¯ç¨‹";
                    fetchData("", latitude, longitude);
                },
                () => { document.getElementById('location-status').innerText = "âŒ è«‹é–‹å•Ÿå®šä½ä»¥å°‹æ‰¾é¤å»³"; }
            );
        }

        // 4. å–å¾— API è³‡æ–™
        async function fetchData(keyword = "", lat = null, lng = null) {
            const listEl = document.getElementById('restaurant-list');
            listEl.innerHTML = `<div class="p-10 text-center"><i class="fa-solid fa-spinner animate-spin text-blue-500 text-3xl"></i></div>`;
            
            try {
                // åŠå¾‘è¨­ç‚º 1600 å…¬å°º (ç´„æ­¥è¡Œ 20 åˆ†é˜)
                const response = await fetch(`${ZEABUR_URL}/api/restaurants?lat=${lat}&lng=${lng}&radius=1600&keyword=${keyword}`);
                const data = await response.json();
                if (data.status === "OK") {
                    allPlaces = data.results;
                    renderList(allPlaces);
                }
            } catch (err) {
                listEl.innerHTML = `<p class="text-center text-red-400 text-xs">Zeabur é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ URL</p>`;
            }
        }

        function renderList(list) {
            const listEl = document.getElementById('restaurant-list');
            listEl.innerHTML = list.map(place => `
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-50 flex justify-between items-center active:scale-95 transition" onclick="window.open('https://www.google.com/maps/search/?api=1&query=${place.name}&query_place_id=${place.place_id}')">
                    <div class="flex-1">
                        <h4 class="font-bold text-gray-800">${place.name}</h4>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs text-yellow-500 font-bold font-mono">â­ ${place.rating || 'N/A'}</span>
                            <span class="text-[10px] text-gray-400 font-medium">| ${place.vicinity.substring(0,15)}...</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-[10px] text-blue-500 bg-blue-50 px-2 py-1 rounded-lg font-bold">æŸ¥çœ‹è¨‚é¤</div>
                    </div>
                </div>
            `).join('');
        }

        // 5. æƒ…ç·’æŒ‰éˆ•
        function filterByMood(mood) {
            const moodMap = {
                'happy': 'é€Ÿé£Ÿ',
                'sad': 'ç”œé»',
                'angry': 'ç´ é£Ÿ é£²æ–™',
                'fit': 'å¥åº·é¤',
                'nervous': 'é¤é…’é¤¨'
            };
            fetchData(moodMap[mood]);
        }

        // 6. æŠ½ç±¤åŠŸèƒ½ (éœ‡å‹•å‹•ç•«å–ä»£æ—‹è½‰)
        function handleDraw() {
            if (drawLimit <= 0) return;
            if (allPlaces.length === 0) { alert("å°šæœªå–å¾—é¤å»³è³‡æ–™ï¼Œè«‹å…ˆå›åˆ°é¦–é å®šä½"); return; }

            const box = document.getElementById('gacha-box');
            const snarky = document.getElementById('snarky-text');
            const resultCard = document.getElementById('draw-result-card');
            
            box.classList.add('shaking');
            box.innerText = "ğŸ²";
            resultCard.classList.add('hidden');

            setTimeout(() => {
                box.classList.remove('shaking');
                drawLimit--;
                document.getElementById('draw-count').innerText = drawLimit;
                
                const luckyOne = allPlaces[Math.floor(Math.random() * allPlaces.length)];
                
                box.innerText = "ğŸŠ";
                resultCard.classList.remove('hidden');
                document.getElementById('res-name').innerText = luckyOne.name;
                document.getElementById('res-rating').innerText = `â­ ${luckyOne.rating || 'N/A'}`;
                
                snarky.style.opacity = "1";
                if(drawLimit === 2) snarky.innerText = "ä¸æ»¿æ„å–”ï¼ŸğŸ¤¨";
                if(drawLimit === 1) snarky.innerText = "æœ€å¾Œä¸€æ¬¡å›‰...ğŸ˜®â€ğŸ’¨";
                if(drawLimit === 0) {
                    snarky.innerText = "å°±ä½ å•æœ€å¤šï¼æ˜å¤©è¦‹ ğŸ‘‹";
                    document.getElementById('btn-draw').disabled = true;
                }
            }, 800);
        }
    </script>
</body>
</html>